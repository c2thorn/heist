# Project CLOCKWORK - Feature Specification 001
**Title:** Core Architecture & Map System
**Version:** 1.0
**Status:** Approved for Implementation

---

## 1. Overview
This specification defines the "World" of the heist. It transitions the game from a node-based graph to a high-resolution 2D Tile Grid. This grid serves as the "Brain" of the simulation, handling logic, physics, and state, while the renderer interpolates these coordinates for fluid visual output.

---

## 2. The Coordinate Systems

The game runs on two simultaneous coordinate systems. The **Logic Grid** handles rules, and the **World Space** handles rendering.

### 2.1 The Logic Grid (The Brain)
* **Definition:** A 2D matrix of `Tile` objects.
* **Resolution:** 1 Tile = 1 Meter (in-game abstraction).
* **Visual Equivalent:** Approx 32x32 pixels (configurable).
* **Coordinates:** Integers `(x, y)`. `0,0` is Top-Left.
* **Usage:** Used for A* pathfinding, Line-of-Sight (LOS) calculations, and cover logic.

### 2.2 World Space (The Eyes)
* **Definition:** Floating-point pixel coordinates.
* **Coordinates:** Floats `(x, y)`.
* **Usage:** Used for rendering sprites, smooth interpolation, and UI positioning.
* **Conversion Formula:**
    * `GridToWorld(x) = x * TILE_SIZE`
    * `WorldToGrid(x) = Math.floor(x / TILE_SIZE)`

---

## 3. The Grid Data Structure

The Map is a class containing a 2D array of Tiles.

### 3.1 Tile Schema
Every cell in the grid is an object containing fixed properties and dynamic state.

// JSON Representation of a single Tile
{
  "id": "10_15",           // String: "x_y" for fast lookup
  "x": 10, "y": 15,        // Integer: Grid coordinates
  "type": "FLOOR",         // Enum: FLOOR, WALL, VOID
  "terrain": "DEFAULT",    // Enum: DEFAULT, CARPET, TILE, VENT (Affects noise/speed)
  
  // Logical Properties
  "isWalkable": true,      // Boolean: Can units enter?
  "isCover": false,        // Boolean: Does it block LOS or provide concealment?
  "isTransparent": true,   // Boolean: Does it block Vision Rays? (Glass = Walkable:False, Transparent:True)
  
  // Dynamic State
  "occupantId": null,      // String | null: ID of Unit standing here
  "interactableId": null,  // String | null: ID of Door/Terminal/Loot on this tile
  
  // Visibility State
  "visibility": "HIDDEN"   // Enum: HIDDEN (Fog), REVEALED (Intel), VISIBLE (Active LOS)
}

### 3.2 Key Tile Types
1.  **FLOOR:** Walkable, Transparent.
2.  **WALL:** Non-Walkable, Opaque.
3.  **DOOR:**
    * Initially: Non-Walkable, Opaque.
    * State "OPEN": Becomes Walkable, Transparent.
4.  **WINDOW:** Non-Walkable, Transparent.
5.  **VENT:** Walkable (only for Small/Tech units), Opaque.

---

## 4. The Visibility System (Fog of War)

The map uses a tri-state visibility system to enforce the importance of Intel and Line of Sight.

### 4.1 Visibility States
1.  **HIDDEN (The Void):**
    * **Visual:** Pitch black or "Blueprint Blue" sketch.
    * **Logic:** Player cannot see walls, loot, or guards. Player CANNOT place waypoints or target Interactables here.
    * **Default:** All tiles start as HIDDEN unless global intel is bought.

2.  **REVEALED (The Blueprint):**
    * **Visual:** Static architecture is visible. Greyed out / low contrast.
    * **Logic:** Player can see walls and static objects (Doors, Terminals). Player *cannot* see dynamic units (Guards) unless a "Live Feed" asset is active.
    * **Interaction:** Player CAN click here to plan routes.
    * **Source:** Purchasing "Sector Intel" permanently sets tiles to REVEALED.

3.  **VISIBLE (The Live Feed):**
    * **Visual:** Full color, bright, animated.
    * **Logic:** Player sees everything, including Guards and dynamic events.
    * **Source:** Generated by Crew Member Line-of-Sight (Vision Cones) or Hacked Cameras during the heist.

---

## 5. The Navigation Mesh (NavMesh)

Pathfinding does not scan every pixel; it scans the Logic Grid.

### 5.1 A* Configuration
* **Library:** Use a standard A* implementation (e.g., `easystarjs` or custom).
* **Heuristics:** Manhattan Distance.
* **Diagonals:** Enabled, but with higher movement cost (approx 1.4x) to encourage natural movement.

### 5.2 Movement Costs (Weights)
To create natural behavior, we assign weights to tiles.
* **Base Floor:** Cost 10.
* **High Traffic (Carpet):** Cost 10.
* **Loud Surface (Gravel/Tile):** Cost 20 (Discourage unless rushing).
* **Ventilation:** Cost 30 (Slow movement).
* **Guard Zones:** Cost 50 (Soft avoidance - prefer going around known guard posts if possible).

---

## 6. The Asset Layer (Arrangements)

"Arrangements" (Pre-Heist modifications) are an overlay system. They do not overwrite the base map file; they modify the Tile state at initialization.

### 6.1 The Asset Overlay Map
The Game Manager holds a Dictionary of `ActiveAssets`.

// Example Asset Data Structure
{
  "assetId": "bribe_guard_01",
  "targetTile": "15_20",
  "type": "MODIFY_STATE",
  "payload": {
    "targetType": "GUARD",
    "action": "REMOVE" 
  }
}

### 6.2 Initialization Flow
1.  **Load Map:** The simulation loads the static JSON map definition.
2.  **Apply Intel:** Tiles marked as "Purchased" in the meta-save are set to `REVEALED`.
3.  **Apply Assets:** The engine iterates through the `ActiveAssets` list.
    * If Asset is `UNLOCK_DOOR`, find Door at `targetTile` and set state to `OPEN`.
    * If Asset is `DISABLE_CAMERA`, find Camera at `targetTile` and set `isActive = false`.
4.  **Bake NavMesh:** The A* graph is generated *after* assets are applied (e.g., an unlocked door is now a valid path).

---

## 7. Interaction Nodes

Objects that the Crew can manipulate are separate entities anchored to the grid.

### 7.1 Interactable Entity
* **Anchors:** Linked to a specific `x,y`.
* **Access Points:** Defined list of neighbor tiles `[{x,y}, {x,y}]` from which a Crew member can interact with this object.
    * *Example:* A computer terminal is at `5,5`. Access point is `5,6` (Standing in front of it).
* **Properties:**
    * `requiredRole`: "TECH" (optional).
    * `difficulty`: Integer (1-100).
    * `duration`: Integer (Base seconds to complete).
    * `onComplete`: Event trigger (e.g., "UNLOCK_VAULT").

---

## 8. Implementation Priorities
1.  **Grid Generator:** Function to generate a 32x32 test grid with Walls and Floor.
2.  **Renderer:** Canvas loop that draws tiles based on their Type and Visibility state.
3.  **Input Handler:** Mouse click converts Screen Pixels -> World Pixels -> Grid Coordinates to log the clicked tile info.